<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LOL 회원 관리</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;
        
        firebase.initializeApp({
            apiKey: "AIzaSyBQKKW65qAGNpa1G51hf2ntRw10hZNg8s0",
            authDomain: "member-system-d4684.firebaseapp.com",
            projectId: "member-system-d4684",
            storageBucket: "member-system-d4684.firebasestorage.app",
            messagingSenderId: "904998203480",
            appId: "1:904998203480:web:6686cdc25fff8bdae75a2d"
        });
        const db = firebase.firestore();

        const positions = ['없음', '탑', '정글', '미드', '원딜', '서폿'];

        function App() {
            const [members, setMembers] = useState([]);
            const [loading, setLoading] = useState(true);
            const [showForm, setShowForm] = useState(false);
            const [search, setSearch] = useState('');
            const [form, setForm] = useState({
                name: '', nickname: '', birthYear: '', tier: '',
                mainPosition: '없음', subPosition: '없음', note: ''
            });

            useEffect(() => {
                return db.collection('lol_members').orderBy('createdAt', 'desc')
                    .onSnapshot(snap => {
                        setMembers(snap.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                        setLoading(false);
                    });
            }, []);

            const handleSubmit = async () => {
                if (!form.name || !form.nickname) {
                    alert('이름과 닉네임은 필수입니다!');
                    return;
                }
                await db.collection('lol_members').add({
                    ...form,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                setForm({ name: '', nickname: '', birthYear: '', tier: '', 
                         mainPosition: '없음', subPosition: '없음', note: '' });
                setShowForm(false);
            };

            const handleDelete = async (id) => {
                if (confirm('삭제하시겠습니까?')) {
                    await db.collection('lol_members').doc(id).delete();
                }
            };

            const handleCSV = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                Papa.parse(file, {
                    complete: async (results) => {
                        const batch = db.batch();
                        let count = 0;
                        
                        results.data.forEach((row, i) => {
                            if (i < 13 || !row[1] || !row[2]) return;
                            
                            const positions = [row[13], row[14], row[15], row[16], row[17]];
                            const mainIdx = positions.findIndex(p => p === '●');
                            const subIdx = positions.findIndex(p => p === '○');
                            const posNames = ['탑', '정글', '미드', '원딜', '서폿'];
                            
                            batch.set(db.collection('lol_members').doc(), {
                                name: row[1],
                                nickname: row[2],
                                birthYear: row[3] || '',
                                tier: row[10] || '',
                                mainPosition: mainIdx >= 0 ? posNames[mainIdx] : '없음',
                                subPosition: subIdx >= 0 ? posNames[subIdx] : '없음',
                                note: row[7] || '',
                                createdAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            count++;
                        });
                        
                        await batch.commit();
                        alert(`${count}명 추가 완료!`);
                        e.target.value = '';
                    },
                    encoding: 'UTF-8'
                });
            };

            const getOpggLink = (nickname) => {
                const converted = nickname.replace('#', '-');
                return `https://op.gg/ko/lol/summoners/kr/${encodeURIComponent(converted)}`;
            };

            const filtered = members.filter(m => 
                m.name.includes(search) || m.nickname.toLowerCase().includes(search.toLowerCase())
            );

            if (loading) return <div className="flex justify-center items-center h-screen">로딩중...</div>;

            return (
                <div className="min-h-screen bg-gray-50 p-4">
                    <div className="max-w-7xl mx-auto">
                        <div className="bg-white rounded-lg shadow p-4 mb-4">
                            <h1 className="text-2xl font-bold mb-3">LOL 회원 관리</h1>
                            <div className="flex gap-2">
                                <input
                                    type="text"
                                    placeholder="검색..."
                                    value={search}
                                    onChange={(e) => setSearch(e.target.value)}
                                    className="flex-1 px-3 py-2 border rounded"
                                />
                                <button
                                    onClick={() => setShowForm(true)}
                                    className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
                                >
                                    추가
                                </button>
                                <label className="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 cursor-pointer">
                                    CSV
                                    <input type="file" accept=".csv" onChange={handleCSV} className="hidden" />
                                </label>
                            </div>
                        </div>

                        {showForm && (
                            <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                                <div className="bg-white rounded-lg p-4 w-full max-w-md">
                                    <h2 className="text-lg font-bold mb-3">회원 추가</h2>
                                    <div className="space-y-2">
                                        <input
                                            placeholder="이름*"
                                            value={form.name}
                                            onChange={(e) => setForm({...form, name: e.target.value})}
                                            className="w-full px-3 py-2 border rounded"
                                        />
                                        <input
                                            placeholder="닉네임#태그*"
                                            value={form.nickname}
                                            onChange={(e) => setForm({...form, nickname: e.target.value})}
                                            className="w-full px-3 py-2 border rounded"
                                        />
                                        <div className="grid grid-cols-2 gap-2">
                                            <input
                                                placeholder="생년"
                                                value={form.birthYear}
                                                onChange={(e) => setForm({...form, birthYear: e.target.value})}
                                                className="px-3 py-2 border rounded"
                                            />
                                            <input
                                                placeholder="티어"
                                                value={form.tier}
                                                onChange={(e) => setForm({...form, tier: e.target.value})}
                                                className="px-3 py-2 border rounded"
                                            />
                                        </div>
                                        <div className="grid grid-cols-2 gap-2">
                                            <select
                                                value={form.mainPosition}
                                                onChange={(e) => setForm({...form, mainPosition: e.target.value})}
                                                className="px-3 py-2 border rounded"
                                            >
                                                <option disabled>주라인</option>
                                                {positions.map(p => <option key={p} value={p}>{p}</option>)}
                                            </select>
                                            <select
                                                value={form.subPosition}
                                                onChange={(e) => setForm({...form, subPosition: e.target.value})}
                                                className="px-3 py-2 border rounded"
                                            >
                                                <option disabled>부라인</option>
                                                {positions.map(p => <option key={p} value={p}>{p}</option>)}
                                            </select>
                                        </div>
                                        <input
                                            placeholder="비고"
                                            value={form.note}
                                            onChange={(e) => setForm({...form, note: e.target.value})}
                                            className="w-full px-3 py-2 border rounded"
                                        />
                                    </div>
                                    <div className="flex gap-2 mt-3">
                                        <button
                                            onClick={handleSubmit}
                                            className="flex-1 bg-blue-600 text-white py-2 rounded hover:bg-blue-700"
                                        >
                                            저장
                                        </button>
                                        <button
                                            onClick={() => setShowForm(false)}
                                            className="flex-1 bg-gray-300 py-2 rounded hover:bg-gray-400"
                                        >
                                            취소
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                        <div className="bg-white rounded-lg shadow overflow-hidden">
                            <div className="overflow-x-auto">
                                <table className="w-full text-sm">
                                    <thead className="bg-gray-50">
                                        <tr>
                                            <th className="px-3 py-2 text-left">이름</th>
                                            <th className="px-3 py-2 text-left">닉네임</th>
                                            <th className="px-3 py-2 text-left">티어</th>
                                            <th className="px-3 py-2 text-left">주라인</th>
                                            <th className="px-3 py-2 text-left">부라인</th>
                                            <th className="px-3 py-2 text-left">OP.GG</th>
                                            <th className="px-3 py-2 text-left">작업</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {filtered.map(m => (
                                            <tr key={m.id} className="border-t hover:bg-gray-50">
                                                <td className="px-3 py-2">{m.name}</td>
                                                <td className="px-3 py-2 font-mono text-xs">{m.nickname}</td>
                                                <td className="px-3 py-2">
                                                    <span className="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs">
                                                        {m.tier || '-'}
                                                    </span>
                                                </td>
                                                <td className="px-3 py-2">{m.mainPosition}</td>
                                                <td className="px-3 py-2">{m.subPosition}</td>
                                                <td className="px-3 py-2">
                                                    <a 
                                                        href={getOpggLink(m.nickname)}
                                                        target="_blank"
                                                        className="text-blue-600 hover:underline"
                                                    >
                                                        전적
                                                    </a>
                                                </td>
                                                <td className="px-3 py-2">
                                                    <button
                                                        onClick={() => handleDelete(m.id)}
                                                        className="text-red-600 hover:text-red-800 text-xs"
                                                    >
                                                        삭제
                                                    </button>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                                {filtered.length === 0 && (
                                    <div className="text-center py-8 text-gray-500">데이터가 없습니다</div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
