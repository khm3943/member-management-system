<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LOL 회원 관리 시스템</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;

        // Firebase 설정
        const firebaseConfig = {
            apiKey: "AIzaSyBQKKW65qAGNpa1G51hf2ntRw10hZNg8s0",
            authDomain: "member-system-d4684.firebaseapp.com",
            projectId: "member-system-d4684",
            storageBucket: "member-system-d4684.firebasestorage.app",
            messagingSenderId: "904998203480",
            appId: "1:904998203480:web:6686cdc25fff8bdae75a2d"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        function App() {
            const [members, setMembers] = useState([]);
            const [loading, setLoading] = useState(true);
            const [showAddForm, setShowAddForm] = useState(false);
            const [searchTerm, setSearchTerm] = useState('');
            const [formData, setFormData] = useState({
                name: '', nickname: '', birthYear: '', joinDate: '', 
                tier: '', position: '', warning: '', uniqueId: '', note: ''
            });

            // Firebase 데이터 로드
            useEffect(() => {
                const unsubscribe = db.collection('lol_members').orderBy('createdAt', 'desc')
                    .onSnapshot(snapshot => {
                        const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setMembers(data);
                        setLoading(false);
                    });
                return () => unsubscribe();
            }, []);

            // 회원 추가
            const handleAddMember = async () => {
                if (!formData.name || !formData.nickname) {
                    alert('이름과 닉네임은 필수입니다!');
                    return;
                }
                await db.collection('lol_members').add({
                    ...formData,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                setFormData({
                    name: '', nickname: '', birthYear: '', joinDate: '', 
                    tier: '', position: '', warning: '', uniqueId: '', note: ''
                });
                setShowAddForm(false);
            };

            // 회원 삭제
            const handleDelete = async (id) => {
                if (confirm('정말 삭제하시겠습니까?')) {
                    await db.collection('lol_members').doc(id).delete();
                }
            };

            // CSV 임포트
            const handleCSVImport = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                Papa.parse(file, {
                    complete: async (results) => {
                        const batch = db.batch();
                        let count = 0;
                        
                        results.data.forEach((row, index) => {
                            if (index < 13) return; // 헤더 스킵
                            if (!row[1] || !row[2]) return; // 이름, 닉네임 없으면 스킵
                            
                            const docRef = db.collection('lol_members').doc();
                            batch.set(docRef, {
                                name: row[1],
                                nickname: row[2],
                                birthYear: row[3] || '',
                                joinDate: row[4] || '',
                                warning: row[5] || '',
                                uniqueId: row[6] || '',
                                note: row[7] || '',
                                tier: row[10] || '',
                                position: `${row[13]||''}${row[14]||''}${row[15]||''}${row[16]||''}${row[17]||''}`,
                                createdAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            count++;
                        });
                        
                        await batch.commit();
                        alert(`${count}명의 회원이 추가되었습니다!`);
                    },
                    encoding: 'UTF-8'
                });
            };

            // 필터링된 회원
            const filteredMembers = members.filter(m => 
                m.name.includes(searchTerm) || m.nickname.toLowerCase().includes(searchTerm.toLowerCase())
            );

            if (loading) return <div className="flex justify-center items-center h-screen">로딩중...</div>;

            return (
                <div className="min-h-screen bg-gray-50 p-4">
                    <div className="max-w-7xl mx-auto">
                        {/* 헤더 */}
                        <div className="bg-white rounded-lg shadow p-6 mb-6">
                            <h1 className="text-3xl font-bold mb-4">LOL 회원 관리 시스템</h1>
                            <div className="flex gap-4 items-center">
                                <input
                                    type="text"
                                    placeholder="이름 또는 닉네임 검색..."
                                    value={searchTerm}
                                    onChange={(e) => setSearchTerm(e.target.value)}
                                    className="flex-1 px-4 py-2 border rounded-lg"
                                />
                                <button
                                    onClick={() => setShowAddForm(true)}
                                    className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700"
                                >
                                    회원 추가
                                </button>
                                <label className="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 cursor-pointer">
                                    CSV 가져오기
                                    <input type="file" accept=".csv" onChange={handleCSVImport} className="hidden" />
                                </label>
                            </div>
                        </div>

                        {/* 회원 추가 모달 */}
                        {showAddForm && (
                            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                                <div className="bg-white rounded-lg p-6 w-full max-w-md">
                                    <h2 className="text-xl font-bold mb-4">새 회원 추가</h2>
                                    <div className="space-y-3">
                                        <input
                                            placeholder="이름*"
                                            value={formData.name}
                                            onChange={(e) => setFormData({...formData, name: e.target.value})}
                                            className="w-full px-3 py-2 border rounded"
                                        />
                                        <input
                                            placeholder="닉네임* (예: 크 넹#크 넹)"
                                            value={formData.nickname}
                                            onChange={(e) => setFormData({...formData, nickname: e.target.value})}
                                            className="w-full px-3 py-2 border rounded"
                                        />
                                        <input
                                            placeholder="생년 (예: 1990)"
                                            value={formData.birthYear}
                                            onChange={(e) => setFormData({...formData, birthYear: e.target.value})}
                                            className="w-full px-3 py-2 border rounded"
                                        />
                                        <input
                                            placeholder="티어 (예: Diamond 4)"
                                            value={formData.tier}
                                            onChange={(e) => setFormData({...formData, tier: e.target.value})}
                                            className="w-full px-3 py-2 border rounded"
                                        />
                                        <input
                                            placeholder="포지션 (예: 탑, 정글)"
                                            value={formData.position}
                                            onChange={(e) => setFormData({...formData, position: e.target.value})}
                                            className="w-full px-3 py-2 border rounded"
                                        />
                                    </div>
                                    <div className="flex gap-3 mt-4">
                                        <button
                                            onClick={handleAddMember}
                                            className="flex-1 bg-blue-600 text-white py-2 rounded hover:bg-blue-700"
                                        >
                                            추가
                                        </button>
                                        <button
                                            onClick={() => setShowAddForm(false)}
                                            className="flex-1 bg-gray-300 py-2 rounded hover:bg-gray-400"
                                        >
                                            취소
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* 회원 목록 */}
                        <div className="bg-white rounded-lg shadow overflow-hidden">
                            <table className="w-full">
                                <thead className="bg-gray-50">
                                    <tr>
                                        <th className="px-4 py-3 text-left">이름</th>
                                        <th className="px-4 py-3 text-left">닉네임</th>
                                        <th className="px-4 py-3 text-left">생년</th>
                                        <th className="px-4 py-3 text-left">티어</th>
                                        <th className="px-4 py-3 text-left">포지션</th>
                                        <th className="px-4 py-3 text-left">OP.GG</th>
                                        <th className="px-4 py-3 text-left">작업</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {filteredMembers.map(member => (
                                        <tr key={member.id} className="border-t hover:bg-gray-50">
                                            <td className="px-4 py-3">{member.name}</td>
                                            <td className="px-4 py-3">{member.nickname}</td>
                                            <td className="px-4 py-3">{member.birthYear}</td>
                                            <td className="px-4 py-3">
                                                <span className="px-2 py-1 bg-blue-100 text-blue-800 rounded text-sm">
                                                    {member.tier || '-'}
                                                </span>
                                            </td>
                                            <td className="px-4 py-3">{member.position || '-'}</td>
                                            <td className="px-4 py-3">
                                                <a 
                                                    href={`https://op.gg/summoners/kr/${encodeURIComponent(member.nickname.split('#')[0])}`}
                                                    target="_blank"
                                                    className="text-blue-600 hover:underline"
                                                >
                                                    전적검색
                                                </a>
                                            </td>
                                            <td className="px-4 py-3">
                                                <button
                                                    onClick={() => handleDelete(member.id)}
                                                    className="text-red-600 hover:text-red-800"
                                                >
                                                    삭제
                                                </button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                            {filteredMembers.length === 0 && (
                                <div className="text-center py-8 text-gray-500">
                                    회원이 없습니다.
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
